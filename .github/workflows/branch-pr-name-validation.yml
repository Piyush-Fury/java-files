name: Validate Branch and PR Naming
on:
  push:
    branches:
      - '*'
  pull_request:
    types: [opened, synchronize, reopened]
jobs:
  check-naming-convention:
    runs-on: ubuntu-latest
    
    steps:
      # Step to checkout the code
      - name: Checkout code
        uses: actions/checkout@v3
        
      # Check branch name for JIRA ticket
      - name: Check branch name for JIRA ticket
        run: |
          BRANCH_NAME=$(git rev-parse --abbrev-ref HEAD)
          echo "Branch name: $BRANCH_NAME"
          
          # Validate that branch name includes JIRA ticket (e.g., IAMOPS-123)
          if [[ ! "$BRANCH_NAME" =~ ^[A-Z]+-[0-9]+ ]]; then
            echo "Branch name must include a JIRA ticket ID (e.g., IAMOPS-123)"
            exit 1  # Fail the action and prevent the push or PR
          fi

      # Check PR title for JIRA ticket if PR exists
      - name: Check PR title for JIRA ticket
        run: |
          PR_TITLE=$(gh pr view --json title -q ".title" || echo "No PR found")
          if [[ "$PR_TITLE" == "No PR found" ]]; then
            echo "No open PR found for this branch, skipping PR title check."
            exit 0  # Success exit code to skip error
          fi
          echo "PR title: $PR_TITLE"

          if [[ ! "$PR_TITLE" =~ ^[A-Z]+-[0-9]+ ]]; then
            echo "PR title must include a JIRA ticket ID (e.g., IAMOPS-123)"
            exit 1  # Fail the action and prevent the PR from being merged
          fi
          
        env:
          GH_TOKEN: ${{ github.token }}
